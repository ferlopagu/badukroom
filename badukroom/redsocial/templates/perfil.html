{% extends "base.html" %} {% block title %}My amazing blog{% endblock %}
{% load staticfiles %}
{% block cuerpo %} 
<p>Welcome, {{ user.username }}. Thanks for logging in.</p>

<div class="wrapper">
	<div class="box">
		<div class="row row-offcanvas row-offcanvas-left">
			<!-- sidebar left-->
			<div class="column col-sm-2 col-xs-1 sidebar-offcanvas" id="sidebar1">
				<ul class="nav">
					<li><a href="#" data-toggle="offcanvas" class="visible-xs text-center"><i class="glyphicon glyphicon-chevron-right"></i></a></li>
				</ul>

				<ul class="nav hidden-xs" id="lg-menu">
					<li class="active"><a href="#featured"><i class="glyphicon glyphicon-list-alt"></i> Mensajes</a></li>
					<li><a href="#stories"><i class="glyphicon glyphicon-list"></i> Grupos</a></li>
					<li><a href="{% url 'redsocial:ver_notificaciones' %}"><i class="glyphicon glyphicon-paperclip"></i> Notificaciones <span id="notificaciones" class="badge">12</span></a></li>
					<li><a href="#"><i class="glyphicon glyphicon-refresh"></i> Refresh</a></li>
				</ul> 
			</div>
			<!-- /sidebar left-->

			<!-- main right col -->
			<div class="column col-sm-8 col-xs-12" id="main">
				<div class="padding">
					<div class="full col-sm-12">
						<!-- content -->                      
						<div class="row">
							<!-- main col left -->
							<!-- Creamos una columna de tamaño 3 sin utilizar -->
							<div class="col-sm-3">
							</div>
							<!-- centrar la columna principal-->
							<div class="col-sm-6">
								
									<!--  
									<form class="form-horizontal" role="form">
										<h4>¿Qué estás pensando?</h4>
										<div class="form-group" style="padding:14px;">
											<textarea class="form-control" placeholder="Actualiza tu estado"></textarea>
										</div>
										<button class="btn btn-primary pull-right" type="button">Publicar</button>
										<ul class="list-inline">
											<li><a href=""><i class="glyphicon glyphicon-upload"></i></a></li>
											<li><a href=""><i class="glyphicon glyphicon-camera"></i></a></li>
										</ul>
									</form>
									-->


									<!-- { csrf_token } -->

									<div class="jumbotron">
										{%for e in lista_dic_imagenes %}
										<img src='/static/{{e.perfil}}' >
										<img src="/static/{{e.portada}}" >
									{% endfor %}
									
									
									
									{% for e in lista_diccionario_comentarios %} 
											<h3 id="nombre">{{e.perfil.user.first_name}}</h3>
											<h3 id="apellidos">{{e.perfil.user.last_name}}</h3>
											<h5 id="nick">{{e.perfil.user.username}}</h5>
									{% endfor %}
									
									
									
									{% for option in lista_dic_amigo %}
										{% if option.somos_nosotros == True %}
											<a href="#" class="btn btn-info" role="button">Somos Nosotros</a>  <!-- Esta opcion sobra -->
										{% elif option.es_amigo == True %}
											<a href="#" class="btn btn-info" role="button">Eliminar amigo</a>
										{% elif option.peticion_enviada == True %}
											<a id="#" href="#" class="btn btn-info" role="button">La peticion ya ha sido enviada</a>
										{% elif option.peticion_recibida == True %}
											<a id="aceptar" href="#" class="btn btn-info" role="button">Aceptar peticion de amistad</a>
											<a id="rechazar" href="#" class="btn btn-info" role="button">Rechazar peticion de amistad</a>
										{% else %}
											<a id="agregar" href="#" class="btn btn-info" role="button">Agregar como amigo</a>
										{% endif %}
									{% endfor %}
									
									</div>
									
								<div id='modal'>
								</div>

								<div class="well">
									<form id='formulario' method="post"
										action="{% url 'redsocial:creaComentario' %}"
										enctype="multipart/form-data">
										{% csrf_token %} {{formulario.as_p}}
										<p>
											<input id='enviar' type='submit' value='enviar' />
										</p>
									</form>
								</div>
								
								{% for e in lista_diccionario_comentarios %} 
									<!-- { if e.perfil.user.username == user.username }  -->
										{% for dic in e.comentarios %}

											<div class="panel panel-default">
												<div class="panel-heading">
													<h4>{{ dic.comentario.perfil.user.username }}</h4>
												</div>
												<div class="panel-body">
													{{ dic.comentario.texto }}													
												</div>
												<div class="collapse navbar-collapse navbar-ex1-collapse">
													<ul class="nav navbar-nav">
														<li><a href="#">Me gusta</a></li>
														<li><a href="#">Comentar</a></li>	
													</ul>
												</div>
												{% for r in dic.respuestas %}
													<div class="panel-body">
														{{ r.texto }}													
													</div>
												{% endfor %} 
											</div>
										{% endfor %} 
									<!-- { endif }  -->
								{% endfor %}
								<div data-wgo="{% static 'sgf/ersev-angler59.sgf' %}">
									Sorry, your browser doesn't support WGo.js. Download SGF <a
										href="{% static 'sgf/ersev-angler59.sgf' %}">directly</a>.
								</div>

							</div> <!-- fin columna principal--> 
							<!--Creamos el margen derecho para centrar la de arriba con una columna falsa de 3 -->
							<div class="col-sm-3">
							</div>
						</div><!--/row-->
					</div><!-- /col-9 -->
				</div><!-- /padding -->
			</div><!-- /main -->

						<!-- sidebar right-->
			<div class="column col-sm-2 col-xs-1 sidebar-offcanvas" id="sidebar2">
				<ul class="nav">
					<li><a href="#" data-toggle="offcanvas" class="visible-xs text-center"><i class="glyphicon glyphicon-chevron-right"></i></a></li>
				</ul>

				<ul class="nav hidden-xs" id="lg-menu">
					<li class="active"><a href="#featured"><i class="glyphicon glyphicon-list-alt"></i> Mensajes</a></li>
					<li><a href="#stories"><i class="glyphicon glyphicon-list"></i> Grupos</a></li>
					<li><a href="#"><i class="glyphicon glyphicon-paperclip"></i> Notificaciones</a></li>
					<li><a href="#"><i class="glyphicon glyphicon-refresh"></i> Refresh</a></li>
				</ul> 
			</div>
			<!-- /sidebar right-->

		</div>
	</div>
</div>
{% endblock cuerpo %}

{% block js %}
	<script>
	
	//definimos la funcion contar con jquery a la que llamamos al final del script
	$.contar=function(){
		$.get("{% url 'redsocial:contar_notificaciones' %}", function(data){
			$('#notificaciones').text(data);
	    });
	}
	
	$.aceptarPeticion=function(){
		$('#aceptar').on('click', function(event) {
			event.preventDefault();
			alert("entramos en aceptarPeticion");
			alert($('#nick').text());
			$.get("{% url 'redsocial:aceptar_peticion' %}",{ nick: $('#nick').text() }, function(data){
				alert('Vamos a recargar porque fue un exito')
				//location.reload(true);
				html="";
				html+="<div class='modal-body'> <p>"+data+"</p></div>";
				$('#modal').html(html);
			});
		});
	}
	
	$.declinarPeticion=function(){
		$('#rechazar').on('click', function(event){
			event.preventDefault();
			alert("entramos en borrarPeticion");
			alert($('#nick').text());
			$.get("{% url 'redsocial:declinar_peticion' %}", {nick: $('#nick').text() }, function(data){
				alert('Vamos a recargar porque se borró con exito');
				location.reload(true);
			});
		});
	}
	
	
	$('#formulario').submit(function(event) { // catch the form's submit event
    	event.preventDefault();
    	$.ajax({ // create an AJAX call...
            data: $(this).serialize(), // get the form data
            type: $(this).attr('method'), // GET or POST
            url: $(this).attr('action'), // the file to call
            success: function(data){ // on success..
            	console.log("comentario creado");
            	console.log(data);
            	console.log("recargando página");
            	location.reload(true);

            }  
        });
    	
    });
	
	$('#buscar').on('click', function(event) { // catch the form's submit event
    	event.preventDefault();
		alert($('#buscar_texto').val())
	
    	$.ajax({ // create an AJAX call...
            data: {"texto":$('#buscar_texto').val()}, // get the form data
            type: 'POST', // GET or POST
            url: "{% url 'redsocial:buscar' %}", // the file to call
            success: function(data){ // on success..
            	console.log(data);
            	console.log("construyendo enlaces");
            	html=""
            	for(var i=0;i<data.length; i++){
            		console.log(data[i]);
            		console.log(data[i].username);
            		html+="<a href='/redsocial/"+data[i].username+"' class='list-group-item'>"+data[i].first_name+" "+data[i].last_name+"</a>"
            	}
            	$('#list-group').html(html)
            	/*window.location("{ url 'redsocial:{username}' }");*/
            }  
        });
    	
    });
	
	$('#agregar').on('click', function(event){
		event.preventDefault();
		var perfil=$('#nick').text();
		console.log(perfil);
		alert($('#nick').text());
		$.ajax({
			data:{"perfil_para_agregar":perfil},
			type:'POST',
			url: "{% url 'redsocial:agregar_ajax' %}",
			success: function(data){
				var perfil=$('#nick').text();
				console.log(perfil);
				console.log(data);
			}
		});
	});
	
	$(function(){
		$.contar();
		$.aceptarPeticion();
	});
	
	
	</script>

{% endblock js %}
